# SALI:2.0
#  ^ Required, this is used to check if the master_script is compatible
#    It must be on the firstline of the master script

# An example use of the new master_script
#  required functions; initialize and partition

## Intialize the SALI environment
# required
initialize(){
    ## variables
    #SALI_SSHD_KEYS="http://${SALI_IMAGESERVER}:8000/ssh_keys.tar"

    ## Currently only rsync supported, also scripts are always fetched, even wen pre_installation and post_installation
    ## have not been configured
    SALI_SCRIPTS="rsync://${SALI_IMAGESERVER}/scripts"

    ## Where can I find the image (for torrent and rsync), based on the variable PROTOCOL
    ## rsync of bittorrent is used, variables IMAGESERVER and IMAGENAME must be available
    ## via de linux cmd line
    image_torrent "rsync://${SALI_IMAGESERVER}/torrents/${SALI_IMAGENAME}.tar.zst.torrent"
    image_rsync "${SALI_IMAGESERVER}::${SALI_IMAGENAME}" options=aHS

    ## Optional you can specify the root password, you must specify the actual passwd encrypted string
    ## BUT we recommend use ssh pub keys!
    #password root '$6$LXAd1TSI0zeMoCW$LPomOOj3ilnrxyl.xtN30kmB0uAFLZo1.C5VtxUdEzXE0MrJp4j7vFMUID/ol31W8bVNSMJYNg/B8R5mmQmB1/'
    #ssh_authorized_key root "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9B0Fk5Y3T6V/lmljyNIKq7SjUsq+Nl6bxV3SuXM1iJs+0LtJtaTGw5Q7JZDhG07akdUubX/v77m7k47FUczumCqKk0capYooc5z+yGVSXroj8zjJMwiCsGa/i1ejYSgSPlhBZbrOv0JDaFUcFjuuOWSz5GpR6BW8k1fcCL3qDp2amcMbjXPiul0HqK7zt9by17Yio8FkqrCGX9EB4SiFyWwP6YYbwtnwZwf4+MKPvioJUq48OUla6fEJNWGq0s3Q9hmIUdGKsfi87LOIJbSHKFUhk1cYegxGSfQkWbHcLK+61jbXuw0frNeyjWTrPpjlW0GzBUGQ1qe/jPB0kDW3n dennis@llt0012"
}

## The partition function
# required
partition(){    
    # Load local finctions
    . ${SALI_SCRIPTS_DIR}/functions


    SALI_TARGET=/target
    mkdir -p ${SALI_TARGET}

    ## Detect all disks in the system and make them available
    ## via variables $DISK0, $DISK1, etc. Optionally you can
    ## specify a order in which the disks must be sorted.
    ## For example: disks_detect hd,sd, this means that hd* disk
    ## are sorted before sd* disks
    disks_detect sd hd      # <order>

    # Dirty hack
    sleep 60
    disks_detect sd hd      # <order>


    ## Create partitions on specific disks

    ## Syntax required options:
    ##  disk       : disk0, disk1 or complete path to device
    ##  mountpoint : /<path>, swap, none, raid.<id>, pv.<id>
    ##  size       : specify size in MB (-1 means rest of disk)
    ##
    ## Syntax optional options:
    ##  type=<ext2|ext3|ext4|xfs|swap>       currently supported filesystems
    ##  flag=<bios_grub|lvm|raid>            which flag must be set on the partition
    ##                                       when using raid.<id> or lvm.<id> the flag
    ##                                       lvm or raid is optional!
    ##  label=boot                           the label of the partition
    ##  options="-I 128"                     check the man page mkfs.<fstype> for the options
    ##  dirperms=1777                        with which permissions must the mount directory be
    ##
    ##         <disk> <mountpoint> <size> <options>
    #disks_part $DISK0 /boot        512    type=ext2 label=boot
    #disks_part $DISK0 none         1      flag=bios_grub
    #disks_part $DISK0 swap         4096   type=swap label=swap

	# windows_pn=1
	# uefi_pn=2
	# boot_pn=3
	# windistro_pn=5
	# afscache_pn=6
	# swap_pn=7
	# root_pn=8

	# boot_ps=4	# boot
	# swap_ps=4	# swap
	# windows_ps=35	# windows
	# afscache_ps=5	# AFS cache
	# root_ps=46	# root



#    DISK0_SIZE=$(disks_last_size $DISK0)
    # DISK0_SIZE=`parted -s $DISK0 unit MB print | grep 'Disk ' | sed 's/^.*: //g' | sed 's/MB.*$//' | sed 's/MB//' | sed 's/ //'`
    # echo $DISK0_SIZE !!!!!!!!!!!!
    # # boot_size=$(( $DISK0_SIZE * $boot_ps / 100 ))
    # uefi_size=512
    # boot_size=1024
    # windistro_size=30000
    # swap_size=$(( $DISK0_SIZE * $swap_ps / 100 ))
    # windows_size=$(( $DISK0_SIZE * $windows_ps / 100 ))
    # afscache_size=$(( $DISK0_SIZE * $afscache_ps / 100 ))
    # root_size=$(( $DISK0_SIZE * $root_ps / 100 ))

    # logmsg "swapon ${DISK0}${swap_pn}"
    # swapon ${DISK0}${swap_pn}

    # logmsg "mount points"
    # mount -text4 ${DISK0}${root_pn} ${SALI_TARGET}/
    # mkdir -p ${SALI_TARGET}/boot
    # mkdir -p ${SALI_TARGET}/var/cache/openafs
    # mount -text4 ${DISK0}${boot_pn} ${SALI_TARGET}/boot
    # mount -text4 ${DISK0}${afscache_pn} ${SALI_TARGET}/var/cache/openafs
    
    

    ## Reason for seperate option label= and type= is that not all partitions need this information
    ## such as the bios_grub partition, it only needs a flag, therfore we call it a flag instead
    ## of a partition type. And specifying type=none is to much information.

    ## This is a shell script so you can use logic in your masterscript
#    if [ -z "${DISK1}" ]
#    then
#        disks_part "${DISK0}" / 51200 type=xfs label=root
#        disks_part "${DISK0}" /scratch -1 type=xfs label=scratch dirperms=1777
#    else
#        disks_part "${DISK0}" / -1 type=xfs label=root
#        disks_part "${DISK1}" /scratch -1 type=xfs label=scratch dirperms=1777
#    fi
}

disks_mount() {
    # Load local finctions
    . ${SALI_SCRIPTS_DIR}/functions


    SALI_TARGET=/target
    mkdir -p ${SALI_TARGET}
    
  
    p_comment 0 "Mount disks"

    ## root
    p_comment 0 "mount ${DISK0}${root_pn} ${SALI_TARGET}"
    mount -text4 ${DISK0}${root_pn} ${SALI_TARGET}


    p_comment 0 "swapon ${DISK0}${swap_pn}"
    mkswap -L swap ${DISK0}${swap_pn}
    swapon -L swap

    if [ "$(is_yes $UEFI)" -eq 1 ]
    then
	## ESP
	mkdir -p ${SALI_TARGET}/boot/efi
	mount -tvfat ${DISK0}${uefi_pn} ${SALI_TARGET}/boot/efi
    fi

}

getimage_torrent(){
	echo "No torrent file!"
}


## Simplify running post/pre scripts. Instead of specify the order number and image
## name as script name, just specify which scripts you want to use. You can easily
## change the order per type of install and re-use the same scripts

## A function which is called before the partitioning and installation
# optional
#pre_installation(){
#    run_script my_pre_script
#}

## A function which is called after fetching the image optional
post_installation(){
    # Load local finctions
    . ${SALI_SCRIPTS_DIR}/functions


    ## run an shell script in a chrooted environment (the functions file is NOT available in
    ## the chroot env)

    # run_script hostconfig
    run_script grub2-install chroot=yes $DISK0
}

# Local Variables:
# mode: shell-script
# End:
